name: pr-builder
run-name: PR Builder
on: pull_request

permissions: read-all
jobs:      
  static-analysis-scanning:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master
    - name: Checkov Scan
      uses: bridgecrewio/checkov-action@v12
      with:
        # This will add both a CLI output to the console and create a results.sarif file
        output_format: cli,sarif
        output_file_path: console,results.sarif
      
    # - name: Upload SARIF file
    #   uses: github/codeql-action/upload-sarif@v2
      
    #   # Results are generated only on a success or failure
    #   # this is required since GitHub by default won't run the next step
    #   # when the previous one has failed. Security checks that do not pass will 'fail'.
    #   # An alternative is to add `continue-on-error: true` to the previous step
    #   # Or 'soft_fail: true' to checkov.
    #   if: success() || failure()
    #   with:
    #     sarif_file: results.sarif
  terraform-plan:
    needs: static-analysis-scanning
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@master    
    # Terraform Cloud Authentication
    - uses: hashicorp/setup-terraform@v3
    
    - name: Terraform Format
      run: terraform fmt -check
    
    - name: Terraform Init
      run: terraform init
    
    - name: Terraform Plan
      run: terraform plan -out=tfplan
      continue-on-error: true
    
    - name: Upload TF Plan  
      uses: actions/upload-artifact@v4
      with:
        name: tfplan
        path: tfplan